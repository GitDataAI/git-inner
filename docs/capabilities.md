Git 协议能力列表
=====================

服务器 **应该** 支持本文档定义的所有能力。  
在 `receive-pack` 或 `upload-pack` 的**第一行响应**中，第一个引用之后紧跟一个 **NUL 字节**，然后是一个**空格分隔**的服务器能力列表。  
客户端随后发送它**希望启用**的能力列表，**只能**从服务器已声明的能力中选取。  
如果服务器收到自己**未声明**或**不理解**的能力，**必须**中止操作。  
服务器**不得**忽略客户端请求的、且已广告的能力。  
因此，服务器**不得**广告自己不理解的能力。

---

### 能力分类速览

| 能力 | 协议 | 说明 |
|---|---|---|
| `atomic`, `report-status`, `delete-refs`, `quiet`, `push-cert` | receive-pack（推送） | 推送相关 |
| `ofs-delta`, `side-band-64k` | 两者通用 | 传输优化 |
| `agent` | 可选，通用 | 版本标识 |
| 其余 | upload-pack（获取） | 获取相关 |

---

### 能力详述

#### multi_ack
允许服务器一旦找到**共同祖先**就立即返回 `ACK obj-id continue`，减少客户端继续遍历的历史量。  
无此能力时，客户端必须按 `--date-order` 发送 `have`，即使服务器已知道某些提交。

#### multi_ack_detailed
`multi_ack` 的扩展，提供更详细的服务器内部状态信息。详见 `pack-protocol.txt` 的“Packfile Negotiation”。

#### no-done
仅用于**智能 HTTP 协议**。  
若同时启用 `multi_ack_detailed` 与 `no-done`，服务器在首次发送 `ACK obj-id ready` 后可**立即**开始传输包文件，省去客户端再次发送 `done` 的往返。

#### thin-pack
- **瘦包**：包内 delta 的**基础对象不在包中**，但接收端已知存在。
- **upload-pack** 广告 `thin-pack` 表示可生成瘦包；客户端请求该能力表示**会“加厚”**（补充缺失基础对象）。
- **receive-pack** 默认能处理瘦包，可通过广告 `no-thin` 禁止客户端发送瘦包。

#### side-band, side-band-64k
允许在传输包文件的同时**多路复用**进度信息与错误信息。
- `side-band`：每包最多 **1000** 字节（含 1 字节流码）。
- `side-band-64k`：每包最多 **65520** 字节，现代客户端首选。  
  流码含义：
- `1`：包数据
- `2`：进度消息
- `3`：致命错误（随后终止）  
  客户端**最多**只能请求二者之一。

#### ofs-delta
服务器与客户端均支持在包文件中使用 **OBJ_OFS_DELTA**（类型 6），即通过**偏移量**而非 obj-id 引用基础对象。

#### agent
可选。服务器可发送 `agent=X` 告知自身版本；客户端若收到，可回送 `agent=Y`。字符串仅用于**统计与调试**，不得用于功能判断。

#### shallow, deepen-since, deepen-not, deepen-relative
支持**浅克隆**相关命令：
- `deepen`：按深度
- `deepen-since`：按时间截断
- `deepen-not`：按排除的提交
- `deepen-relative`：深度从**当前浅边界**算起，而非远程引用

#### no-progress
客户端使用 `git clone -q` 等时发送，表示**不需要** side-band 的进度流（流 2），但**错误流（流 3）仍保留**。

#### include-tag
若服务器广告该能力，当客户端获取某对象时，**指向该对象的 annotated tag** 也会被一并打包发送，减少后续再次获取标签的往返。

#### report-status
推送时客户端请求该能力，服务器会在**解包与更新引用完成后**返回结果：每引用一行成功/失败信息。

#### delete-refs
服务器广告即表示**接受零-id 作为引用目标**，从而允许客户端**删除引用**。

#### quiet
服务器广告则表明可**抑制人类可读进度输出**；客户端若本地也静默（如 `push -q`），可回送 `quiet` 以请求服务器静默。

#### atomic
服务器广告则支持**原子推送**：要么所有引用更新成功，要么**全部回滚**。

#### push-options
服务器广告则可在**更新命令之后、包文件之前**接收推送选项，并传给 `pre-/post-receive` 钩子。

#### allow-tip-sha1-in-want
#### allow-reachable-sha1-in-want
服务器广告后，客户端可在 `want` 行中请求**未被广告**但服务器存在的对象（前者仅允许** tip**，后者允许**任意可达**对象）。

#### push-cert=&lt;nonce&gt;
服务器广告即表示愿意接受**带签名的推送证书**，并要求证书包含指定 `nonce`。客户端**必须**仅在服务器广告时才发送证书。

#### filter
服务器广告后，客户端可发送 `filter` 命令请求**部分克隆/获取**，让服务器**省略特定对象**（如按大小、路径、blob 等过滤）。